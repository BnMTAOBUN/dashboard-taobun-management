<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TAOBUN Revenue Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
  @font-face {
    font-family: 'Denton Variable';
    src: local('Denton Variable'), local('Denton-Variable');
    font-weight: 100 900;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --primary: #d61e30; 
    --bg: #ffffff;
    --border: #eeeeee;
    --text: #1a1a1a;
    --muted: #777777;
  }

  body {
    font-family: 'Denton Variable', serif;
    background: var(--bg);
    color: var(--text);
    padding: 40px 20px;
    -webkit-font-smoothing: antialiased;
  }

  .container { max-width: 550px; margin: 0 auto; }
  header { text-align: center; margin-bottom: 40px; }
  .badge { display: inline-block; font-size: 11px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--primary); border: 1px solid var(--primary); padding: 6px 16px; border-radius: 4px; margin-bottom: 20px; font-weight: 700; }
  h1 { font-size: 32px; font-weight: 800; line-height: 1; letter-spacing: -0.02em; }
  h1 span { color: var(--primary); }

  .revenue-section { text-align: center; margin-bottom: 40px; }
  .revenue-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 8px; }
  .revenue-value { font-size: 42px; font-weight: 800; color: var(--primary); letter-spacing: -0.03em; }

  .section-label { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #f0f0f0; font-weight: 800; }

  .deck-list { display: flex; flex-direction: column; gap: 20px; margin-bottom: 40px; }
  .deck-item { display: flex; justify-content: space-between; align-items: flex-end; padding: 10px 0; }
  .deck-info { flex: 1; min-width: 0; }
  .deck-title { font-weight: 700; font-size: 15px; margin-bottom: 2px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .target-pill { font-size: 11px; font-weight: 800; color: var(--primary); background: #fff0f1; padding: 2px 8px; border-radius: 4px; display: none; white-space: nowrap; }
  .deck-desc { font-size: 12px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .input-field { display: flex; align-items: baseline; gap: 6px; border-bottom: 2px solid #f0f0f0; padding-bottom: 4px; transition: border-color 0.3s; flex-shrink: 0; }
  .input-field:focus-within { border-color: var(--primary); }
  input { font-family: 'Denton Variable', serif; border: none; background: none; font-size: 18px; font-weight: 800; width: 130px; text-align: right; color: var(--text); outline: none; padding: 0; }
  .unit { font-size: 14px; font-weight: 700; color: var(--muted); }
  .auto-result { font-size: 18px; font-weight: 800; color: var(--primary); padding-bottom: 6px; }

  .charts-grid { display: flex; flex-direction: column; gap: 50px; border-top: 1px solid #f0f0f0; padding-top: 40px; padding-bottom: 60px; }
  .chart-header { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text); margin-bottom: 25px; text-align: center; font-weight: 800; }
  .chart-container { height: 200px; position: relative; }

  @media (max-width: 768px) {
    body { padding: 20px; }
    h1 { font-size: 28px; }
    .revenue-value { font-size: 36px; }
    input { width: 100px; font-size: 17px; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="badge">CV. Roti Semua Generasi</div>
    <h1><span>TAOBUN</span><br>DASHBOARD</h1>
  </header>

  <div class="revenue-section">
    <p class="revenue-label">Projected Revenue</p>
    <div class="revenue-value" id="totalRevenue">Rp 0</div>
  </div>

  <div class="deck-list">
    <p class="section-label">Market</p>
    <div class="deck-item">
      <div class="deck-info">
        <p class="deck-title">Leads <span id="targetLeads" class="target-pill"></span></p>
        <p class="deck-desc">Prospek potensial masuk</p>
      </div>
      <div class="input-field">
        <input type="text" id="leads" value="0" inputmode="decimal" oninput="handleInput(this)" onfocus="this.select()">
      </div>
    </div>

    <p class="section-label" style="margin-top: 20px;">Customer Breakdown</p>
    <div class="deck-item">
      <div class="deck-info">
        <p class="deck-title">Total Customers <span id="targetTotalCust" class="target-pill"></span></p>
        <p class="deck-desc">Jumlah pelanggan bulan ini (New + Retention)</p>
      </div>
      <div class="input-field">
        <input type="text" id="totalCustInput" value="0" inputmode="decimal" oninput="handleInput(this)" onfocus="this.select()">
      </div>
    </div>

    <div class="deck-item">
      <div class="deck-info">
        <p class="deck-title">Retention Customers <span id="targetRetention" class="target-pill"></span></p>
        <p class="deck-desc">Pelanggan lama yang kembali</p>
      </div>
      <div class="input-field">
        <input type="text" id="retentionCust" value="0" inputmode="decimal" oninput="handleInput(this)" onfocus="this.select()">
      </div>
    </div>

    <div class="deck-item">
      <div class="deck-info" style="opacity: 0.7;">
        <p class="deck-title">New Customers <span id="targetNewCust" class="target-pill"></span></p>
        <p class="deck-desc">Selisih (Total - Retention)</p>
      </div>
      <div class="auto-result" id="newCustDisplay">0</div>
    </div>

    <div class="deck-item">
      <div class="deck-info" style="opacity: 0.7;">
        <p class="deck-title">Required Conversion <span id="targetConv" class="target-pill"></span></p>
        <p class="deck-desc">Efektivitas konversi dari Leads (%)</p>
      </div>
      <div class="auto-result" id="convRateDisplay">0%</div>
    </div>

    <p class="section-label" style="margin-top: 20px;">Unit Value</p>
    <div class="deck-item">
      <div class="deck-info">
        <p class="deck-title">Basket Size <span id="targetBasket" class="target-pill"></span></p>
        <p class="deck-desc">Nilai belanja per transaksi</p>
      </div>
      <div class="input-field">
        <span class="unit">Rp</span>
        <input type="text" id="basketSize" value="0" inputmode="decimal" oninput="handleInput(this)" onfocus="this.select()">
      </div>
    </div>

    <div class="deck-item">
      <div class="deck-info">
        <p class="deck-title">Avg Transaction <span id="targetTx" class="target-pill"></span></p>
        <p class="deck-desc">Frekuensi belanja per pelanggan</p>
      </div>
      <div class="input-field">
        <input type="text" id="avgTx" value="0" inputmode="decimal" oninput="handleInput(this)" onfocus="this.select()">
        <span class="unit">x</span>
      </div>
    </div>

    <div class="deck-item" style="border-top: 1px dashed #eee; padding-top: 20px;">
      <div class="deck-info">
        <p class="deck-title">Optimization Target</p>
        <p class="deck-desc">Simulasi kenaikan pada tiap deck (%)</p>
      </div>
      <div class="input-field" style="border-bottom-color: var(--primary);">
        <input type="text" id="optPercent" value="0" inputmode="decimal" oninput="handleInput(this)" onfocus="this.select()" style="color: var(--primary);">
        <span class="unit" style="color: var(--primary);">%</span>
      </div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-box">
      <p class="chart-header">Conversion Funnel Performance (%)</p>
      <div class="chart-container">
        <canvas id="funnelChart"></canvas>
      </div>
    </div>

    <div class="chart-box">
      <p class="chart-header" id="growthHeader">Revenue Growth Strategy (%)</p>
      <div class="chart-container">
        <canvas id="growthChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
Chart.register(ChartDataLabels);
let funnelChart, growthChart;

function initCharts() {
  const fontConfig = { family: 'Denton Variable', size: 11, weight: '700' };
  
  const ctxFunnel = document.getElementById('funnelChart').getContext('2d');
  funnelChart = new Chart(ctxFunnel, {
    type: 'bar',
    data: {
      labels: ['Leads', 'Total Cust', 'Transactions'],
      datasets: [{
        data: [0, 0, 0],
        backgroundColor: ['#f4f4f4', '#d61e30', '#1a1a1a'],
        borderRadius: 4,
        barThickness: 25
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end', align: 'right', color: '#1a1a1a', font: { weight: '800', size: 10 },
          formatter: (value, context) => {
            const data = context.chart.data.datasets[0].data;
            if (context.dataIndex === 0) return '100%';
            if (data[0] === 0) return '0%';
            return ((value / data[0]) * 100).toFixed(1) + '%';
          }
        }
      },
      scales: {
        x: { display: false },
        y: { ticks: { font: fontConfig, color: '#1a1a1a' }, grid: { display: false } }
      }
    }
  });

  const ctxGrowth = document.getElementById('growthChart').getContext('2d');
  growthChart = new Chart(ctxGrowth, {
    type: 'bar',
    data: {
      labels: ['Current', 'Optimized'],
      datasets: [{
        data: [0, 0],
        backgroundColor: ['#1a1a1a', '#d61e30'],
        borderRadius: 6,
        barThickness: 50
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end', align: 'top', color: '#1a1a1a', font: { weight: '800', size: 10 },
          formatter: (value, context) => {
            const data = context.chart.data.datasets[0].data;
            if (context.dataIndex === 0 || data[0] === 0) return 'BASE';
            const growth = ((value / data[0]) - 1) * 100;
            return '+' + growth.toFixed(1) + '%';
          }
        }
      },
      scales: {
        y: { display: false },
        x: { ticks: { font: fontConfig, color: '#1a1a1a' }, grid: { display: false } }
      }
    }
  });
}

function formatNumber(val) {
  let clean = val.toString().replace(/[^0-9,]/g, "");
  let parts = clean.split(",");
  let integerPart = parts[0];
  let decimalPart = parts.length > 1 ? "," + parts[1] : "";
  if (integerPart.length > 1) { integerPart = integerPart.replace(/^0+/, ""); }
  if (integerPart === "") integerPart = "0";
  integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  return integerPart + decimalPart;
}

function cleanNumber(val) {
  let s = val.toString().replace(/\./g, "").replace(",", ".");
  return parseFloat(s) || 0;
}

function handleInput(el) {
  let cursor = el.selectionStart;
  let oldLen = el.value.length;
  el.value = formatNumber(el.value);
  let newLen = el.value.length;
  el.setSelectionRange(cursor + (newLen - oldLen), cursor + (newLen - oldLen));
  calculate();
}

function fmtCurrency(n) {
  if (n === 0) return 'Rp 0';
  if (n >= 1e9) return 'Rp ' + (n/1e9).toFixed(2).replace('.', ',') + ' M';
  if (n >= 1e6) return 'Rp ' + (n/1e6).toFixed(1).replace('.', ',') + ' Jt';
  return 'Rp ' + n.toLocaleString('id-ID', { maximumFractionDigits: 0 });
}

function updateTargetPill(id, value, isVisible, prefix = "", suffix = "") {
  const el = document.getElementById(id);
  if (isVisible && value > 0) {
    let formatted = value.toLocaleString('id-ID', { maximumFractionDigits: 1 });
    el.textContent = `â†’ ${prefix}${formatted}${suffix}`;
    el.style.display = "inline-block";
  } else {
    el.style.display = "none";
  }
}

function calculate() {
  const leads = cleanNumber(document.getElementById('leads').value);
  const totalCustInput = cleanNumber(document.getElementById('totalCustInput').value);
  const retentionCust = cleanNumber(document.getElementById('retentionCust').value);
  const basket = cleanNumber(document.getElementById('basketSize').value);
  const avgTx = cleanNumber(document.getElementById('avgTx').value);
  const optPercent = cleanNumber(document.getElementById('optPercent').value);

  const factor = 1 + (optPercent / 100);
  
  // Logika Baru: New = Total - Retention
  const newCust = Math.max(0, totalCustInput - retentionCust);
  const reqConv = leads > 0 ? (newCust / leads) * 100 : 0;
  const totalTx = totalCustInput * avgTx;
  const currentRevenue = totalTx * basket;
  
  // Optimization Calculation
  const targetLeads = leads * factor;
  const targetTotalCust = totalCustInput * factor;
  const targetRetention = retentionCust * factor;
  const targetNewCust = Math.max(0, targetTotalCust - targetRetention);
  const targetConv = targetLeads > 0 ? (targetNewCust / targetLeads) * 100 : 0;
  const targetBasket = basket * factor;
  const targetTxVal = avgTx * factor;
  const optRevenue = targetTotalCust * targetTxVal * targetBasket;

  // Update Teks
  document.getElementById('totalRevenue').textContent = fmtCurrency(currentRevenue);
  document.getElementById('newCustDisplay').textContent = Math.round(newCust).toLocaleString('id-ID');
  document.getElementById('convRateDisplay').textContent = reqConv.toFixed(1) + '%';
  document.getElementById('growthHeader').textContent = optPercent > 0 ? `Revenue Growth (+${optPercent}%)` : "Revenue Growth Strategy";

  // Update Target Pills
  const showPills = optPercent > 0;
  updateTargetPill('targetLeads', targetLeads, showPills);
  updateTargetPill('targetTotalCust', targetTotalCust, showPills);
  updateTargetPill('targetRetention', targetRetention, showPills);
  updateTargetPill('targetNewCust', targetNewCust, showPills);
  updateTargetPill('targetConv', targetConv, showPills, "", "%");
  updateTargetPill('targetBasket', targetBasket, showPills, "Rp ");
  updateTargetPill('targetTx', targetTxVal, showPills, "", "x");

  if (funnelChart) {
    funnelChart.data.datasets[0].data = [leads, totalCustInput, totalTx];
    funnelChart.update('none');
  }
  if (growthChart) {
    growthChart.data.datasets[0].data = [currentRevenue, optPercent > 0 ? optRevenue : 0];
    growthChart.update('none');
  }
}

window.onload = () => { initCharts(); calculate(); };
</script>

</body>
</html>